---
title: "Stability Regression Analysis Report"
author: "Rachel Molloy"
output: pdf_document
params:
  CI: NA,
  threshold: NA,
  order: NA,
  fullDT: NA,
  raw_full_data: NA,
  meltedDT: NA,
  raw_melted_data: NA,
  shelf_life: NA,
  shelf_life_lower: NA,
  notes: NA,
  author: NA,
  raw_data: NA,
  confidence_bands: NA,
  raw_confidence_bands: NA,
  poly_order: NA,
  raw_shelf_life: NA,
  raw_lower_shelf_life: NA,
  keep: NA,
  exclude: NA
---
<!-- # ```{r, message = TRUE, echo = TRUE} -->
<!-- # # Load data into global environment -->
<!-- # df_fd <- read.csv("f_df.Rdata") -->
<!-- # kable(df_fd, caption="Testing...") -->
<!-- # ``` -->

# _**Settings Selected for Analysis:**_

## Confidence Interval:
`r params$CI`

## % of 4C MFI Threshold:
`r params$threshold`%

## Regression Model:
`r params$order`

# _**Analysis with Raw Data:**_
```{r, message = FALSE, echo = FALSE, warning = FALSE}
library(knitr)
full_data_df <- params$raw_full_data
names(full_data_df)[1:8] <- c("Time (yr)", "30 ng/test", "60 ng/test", "125 ng/test", "250 ng/test", "500 ng/test", "1000 ng/test", "2000 ng/test")
kable(full_data_df, caption = '% of 4C MFI Reference Data at each Concentration')

ggplot(params$raw_melted_data, aes(x=Time, y=value, color=Concentrations)) +
            geom_ribbon(data=params$raw_melted_data, aes(x=Time, y=value, ymin=params$raw_confidence_bands[[2]], ymax=params$raw_confidence_bands[[4]]), formula = y ~ poly(x,params$poly_order, raw=TRUE), method="lm", col = "red", level=as.numeric(params$CI), alpha=0.2) +
            geom_line(data=params$raw_confidence_bands, aes(x=params$raw_confidence_bands[[1]], y=params$raw_confidence_bands[[3]]), formula = y ~ poly(x,params$poly_order, raw=TRUE), method="lm", col = "red") +
            geom_point(size=5) + # plot with keep dataset points filled in only
            labs(x = "Time (years)",
                 y = "% of 4C Reference MFI") +
            theme_minimal() +
            scale_color_brewer(palette = 'Reds', na.translate = F,
                               # labels = unique(keep$Labels)
                               labels = c("30 ng/test", '60 ng/test', '125 ng/test', '250 ng/test', '500 ng/test', '1000 ng/test', '2000 ng/test')
            ) +
            stat_regline_equation(data=params$raw_melted_data, aes(x=Time, y=value,label=paste(..eq.label.., ..rr.label..,..adj.rr.label.., sep = "~~~~~~")), formula = y ~ poly(x,params$poly_order,raw=TRUE), method="lm", col="red",
                                  label.x=1.5,
                                  label.y.npc="top",

                                  size=4) +
            theme(text=element_text(size = 10), legend.position = "bottom")

```

# _***Raw Predicted Shelf-Life:***_

### Based on Polynomial Regression:
`r params$raw_shelf_life`

### Based on Polynomial Regression at Lower 95% Confidence:
`r params$raw_lower_shelf_life`



# _**% of 4C MFI Stability Data:**_

```{r, message = FALSE, echo = FALSE}
library(knitr)
full_data_df <- params$fullDT
# names(full_data_df)[1:8] <- c("Time (yr)", "30 ng/test", "60 ng/test", "125 ng/test", "250 ng/test", "500 ng/test", "1000 ng/test", "2000 ng/test")
kable(full_data_df, caption = '% of 4C MFI Reference Data at each Concentration')
```

# _**Linear Regression Analysis with 95% Confidence:**_
```{r, message = FALSE, echo = FALSE, warning = FALSE}

ggplot(params$keep, aes(x=Time, y=value, color=Concentrations)) +
            geom_ribbon(data=na.omit(params$keep), aes(x=Time, y=value, ymin=params$confidence_bands[[2]], ymax=params$confidence_bands[[4]]), formula = y ~ poly(x,params$poly_order, raw=TRUE), method="lm", col = "red", level=as.numeric(params$CI), alpha=0.2) +
            geom_line(data=params$confidence_bands, aes(x=params$confidence_bands[[1]], y=params$confidence_bands[[3]]), formula = y ~ poly(x,params$poly_order, raw=TRUE), method="lm", col = "red") +
            geom_point(size=5) + # plot with keep dataset points filled in only
            geom_point(data = params$exclude, size = 5, shape = 21, fill = NA, color = 'black') +
            labs(x = "Time (years)",
                 y = "% of 4C Reference MFI") +
            theme_minimal() +
            scale_color_brewer(palette = 'Reds', na.translate = F,
                               labels = unique(params$keep$Labels)
                               # labels = c("30 ng/test", '60 ng/test', '125 ng/test', '250 ng/test', '500 ng/test', '1000 ng/test', '2000 ng/test')
            ) +
            stat_regline_equation(data=params$keep, aes(x=Time, y=value,label=paste(..eq.label.., ..rr.label..,..adj.rr.label.., sep = "~~~~~~")), formula = y ~ poly(x,params$poly_order,raw=TRUE), method="lm", col="red",
                                  label.x=1.5,
                                  label.y.npc="top",

                                  size=4) +
            theme(text=element_text(size = 10), legend.position = "bottom")


# ggplot(params$meltedDT, aes(x=Time, y=value, color=Concentrations)) +
#             geom_smooth(data=params$meltedDT, aes(x=Time, y=value), formula = y ~ x, method="lm", col = "red", level=as.numeric(params$CI)) +
#             geom_point(size=10) + # plot with keep dataset points filled in only
#             geom_point(data = params$meltedDT, size = 10, shape = 21, fill = NA, color = 'black') +
#             labs(x = "Time (years)",
#                           y = "% of 4C Reference MFI") +
#                      theme_minimal() +
#                      scale_color_brewer(palette = 'Reds', na.translate = F,
#                                         labels = unique(params$meltedDT$Labels)
#                                         # labels = c("30 ng/test", '60 ng/test', '125 ng/test', '250 ng/test', '500 ng/test', '1000 ng/test', '2000 ng/test')
#                      )
```

# _**Predicted Shelf-Life:**_

### Based on Polynomial Regression:
`r params$shelf_life`

### Based on Polynomial Regression at Lower 95% Confidence:
`r params$shelf_life_lower`

### Experimental Notes:
`r params$notes`
