---
title: "Stability Regression App README"
author: "Rachel Molloy"
date: "7/4/2021"
output: html_document
---

# **Regression for Stability**
This app is used for Stability studies to dynamically conduct a regression analysis and predict the shelf-life of BDB Research Reagents. There are two workflows this app will support: the Manual and the OMIQ Workflow.

*Manual Workflow*: The experimental data was gated/analyzed manually using FlowJo (the stats generated from FlowJo must be copied into the template and uploaded to the App, although the template is structured very similarly to what the team is currently using).

*OMIQ Workflow*: The experimental data was gated/analyzed using the OMIQ pipeline. An initial regression analysis and shelf-life prediction was already conducted during the execution of OMIQ, but changes may be necessary to the analysis. Therefore, the team may need to use the App to do a dynamic data review, in which case they would upload their OMIQ reports and the `all_stats.csv` file from OMIQ. 

The only differences between the Manual Workflow and OMIQ Workflow in terms of Stability Regression App usage are the sidebar panel layout and user inputs/uploads, and the downloadable output formats.

***

## Sidebar Panel Overview

The sidebar panel using multiple renderUIs based on the `input$analysis_type`:

```r
uiOutput('manual_or_omiq')
```
This renders the 2 `downloadButton`s for the Stats Template and Example if the Manual analysis option is selected, and the `fileInput` for the stats file to be uploaded. Both the Manual and OMIQ analysis types use the same `input$raw_upload` `fileInput` id, but accept different file types (Manual accepts .xlsx files, OMIQ accepts .csv files since that is the file type to which OMIQ outputs the stats). 

```r
uiOutput('manual_or_omiq_cell_pop')
```
This renders the Marker Name text outputted to the sidebar panel, as well as a `selectInput` option to select the cell population to analyze, if `input$analysis_type == "OMIQ"`. The list of cell populations to analyze is based on a list of unique cell populations found in the "pop" column of the `all_stats.csv` file. If the Manual analysis option is selected, nothing additional outputs to the UI.

Several user input parameters used to establish the model and criteria for selecting shelf-life are shown on the sidebar panel for both analysis types:
```r
radioButtons('polynomial_order', "Order of Polynomial", ..., selected = "Linear", ...) # select model polynomial order
selectInput('CI', 'Confidence Interval', ..., selected = 0.95) # select confidence interval to use and find shelf-life from
textInput('threshold', '% of 4C Reference MFI Threshold', value=75) # MFI Threshold to find shelf-life from
```
The defaults selected are default values used in the OMIQ regression report scripts, and have been established by the team as criteria to use for finding shelf-life. If a user selects a different option for any of these parameters, the results will be updated and reflected in the UI and all downloadable outputs. However, the selected parameters themselves will not be outputted to any of the downloadable outputs, so users must indicate so in the Notes section.

If a user selects a polynomial order and the highest order coefficient p-value > 0.05, a warning will output to the UI to indicate to the user that there is no statistical significance in the model order selected:

```r
uiOutput('warning_ui_polynomial_choice')
```

Once a stats file has been successfully uploaded to the app, all unique concentration values will be read from the stats file input and the list of concentrations will be outputted to a `checkboxGroupInput` on the sidebar panel:

```r
uiOutput('concentration_checkGroupInput')
```
This provides the user with the option to exclude entire titration values from the regression analysis and shelf-life prediction. The concentration choice names and values are configured by calling the following functions:

```r
concentration_choice_names <- reactive({ concentration_choiceNames(raw_upload_data()) })
concentration_choice_values <- reactive({ concentration_choiceValues(concentration_choice_names()) })
```
where the `concentration_choiceNames(...)` function finds the list of unique concentrations listed in the stats file upload and appends the values with "ng/test" (this means that the units provided in this App will always be in "ng/test", so the user must upload the data with concentrations in "ng/test"), and the `concentration_choiceValues(...)` function assigns each concentration to a value. All selected concentrations will be assigned to `input$concentrations_to_include`. More details on this are provided in the "How Excluded Data is Handled" section of the README file.

The final `renderUI` on the sidebar panel lays out the UI for configuring final downloadable output, depending on the analysis type selected:
```r
uiOutput('downloadable_outputs_ui')
```

If `input$analysis_type == "Manual"`, the ouput will include the option to add text to the top right corner of certain slides in the PPT output, and adjust the prefixes of the title of certain slides, based on which cell population the stats reflect (the typical Manual Workflow for the Stability team is that if more than 1 cell population is present and analyzed, the slides will represent the cell population name by the 'P1', 'P2', etc. prefix and the free text in the top right corner of the slides). The user can then add a name to the final PPT output and download the PPT with the `input$pptx_id` download button.

If `input$analysis_type == "OMIQ"`, the output will include options to:

1. Download the new regression report generated from any analysis done on the App for an individual cell population (`input$regression_report`)
2. Upload the individual regression report downloaded from `input$regression_reports_indiv`
3. Upload the initial stability report generated by OMIQ that includes the full stability analysis and regression report for all cell populations (`input$omiq_report_upload`)
4. Download the final regression report (`input$regression_report_bundled`) that bundles the individual regression report created by the App with the final OMIQ stability report uploaded from step 3

***

## Main Panel Overview

### Stats Table tab
The % of 4C Reference MFI Table is rendered from:
```r
DT::dataTableOutput("reference_mfi_data_table_keep_only")
```
where the data populated is from the reactive expression generated using the `create_reference_MFI_table_wide_with_keeps(...)` function, which takes in only the data included by the user as an argument. 
```r
reference_MFI_data_to_include_from_keep <- reactive({
    create_reference_MFI_table_wide_with_keeps(keep())
})
```
All concentrations excluded from the sidebar panel will not be shown here, and all excluded individual data points will be NULL in the table.

***

### Plots tab
All plots typically generated by the Stability team are outputted to this tab for the *raw* data only. Data points excluded in the GUI will not be excluded in any of these plots. 

```r
plotOutput('mfi_vs_concentration') # uses mfi_vs_concentration_plot(...) function
plotOutput('mfi_vs_time') # uses mfi_vs_time_plot(...) function
plotOutput('stain_index') # uses stain_index(...) function
plotOutput('signal_to_noise') # uses signal_to_noise(...) function
plotOutput('percent_positive') # uses percent_positive(...) function
plotOutput('percent_of_4C_MFI') # uses percent_of_4C_MFI(...) function
```
Note that the Stain Index and Signal-to-Noise calculations are executed inside their respective functions (see each function referenced in the commented code above). If the Stain Index is Inf or if the rSD- statistic is NA, the Stain Index will be set to NA.

***

### Regression & Shelf-Life tab 

The regression plot plots the % of 4C Reference MFI vs Time for all concentrations selected by the user. The `plotOutput` render function includes additional parameters:
a) `click` to select and toggle off/on individual data points
b) `dblclick` to zoom in and out of the plot
c) `brush` to create a rectangle around the area to zoom in and out of on the plot

```r
plotOutput("regression_plot_output", height = 350,
           click = "regression_plot_output_click",
           dblclick = "regression_plot_zoom_dblclick",
           brush = brushOpts(
               id = "regression_plot_output_brush",
               resetOnNew = TRUE
           )
)
```
The zoom functionality is configured using the `add_zoom(...)` function inside the `server` function.

```r
plot_range <- add_zoom("regression_plot_output")
```

Individual data points that are excluded will be set to `FALSE` in the `vals$keeprows` array, and data points included will be kept as `TRUE` in the array, and used in the analysis. All data points that were excluded on the plot can be reset to be included in the regression analysis and the plot by clicking `input$exclude_reset`. Any concentrations excluded from the sidebar panel will not be reset with this function.

The plot itself is generated using the following function (with `keep()` being the data argument):
```r
regression_plot_global(...) <- function{}
```
and then by applying several other parameters to the plot that are specific to the functionality of the UI, include `geom_point()` for the `exclude()` data, which has no fill and a black outline, the regression fit equation and R^2 value, and the plot range, which needs to be reactive since the user can zoom in on sections of the plot. The `regression_plot_global(...)` function is used to generate both the plots on the UI and plots in the downloadable outputs, and takes arguments related to the font sizes and data point sizes, which differ between the output methods (see Constants section for more details). 

The shelf-life prediction is based on the lower confidence bound, where the confidence interval is set by the user input `input$CI`. The lower shelf life is assigned the variable:
```r
lower_shelf_life <- reactive({ solve_for_lower_shelf_life(...) })
```



### How Excluded Data is Handled

#### Concentrations Excluded:
In the reactive expression,
```r
concentrations_to_include_list()
```
the selected concentrations to include in the analysis will be used as an argument to the function:

```r
concentrations_to_keep(...) <- function{}
```
This will output a data frame with data that includes only the concentrations the user wishes to include in the analysis, and is assigned to the reactive expression:

```r
reference_MFI_data_to_include()
```
This is used as an argument to the function:
```r
melt_reference_mfi_table(...) <- function{}
```
This function uses the `melt()` function to transform the data frame so % of 4C Reference MFI values are all listed in the column "value", and all concentrations are listed in the column "Concentrations". 

***

#### Individual Data Points Excluded:

The outputted data frame returned by the `melt_reference_mfi_table(...)` function is `selected_melted_data()`, and this is used several times throughout the `server` function as an argument/parameter for the `keep()` and `exclude()` reactive expressions, which are two separate data frames with the included and excluded data points only. A `reactiveValues()` called `vals` is initialized, and once the `input$raw_upload` stats file is uploaded, `vals$keeprows` will be updated and only the included data points, given by `selected_melted_data()`, will be set to `TRUE`. 

```r
# For storing which rows have been excluded
vals <- reactiveValues(
    keeprows = rep(TRUE, 56)
)
# Update values of included rows whenever new data is uploaded
observeEvent(input$raw_upload, {
    vals$keeprows <- rep(TRUE, nrow(selected_melted_data()))
    
# Two separate dataframes with the included and excluded data points only, respectively.
keep    <- reactive({ selected_melted_data()[ vals$keeprows, , drop = FALSE] })
exclude <- reactive({ selected_melted_data()[!vals$keeprows, , drop = FALSE] })
})
```

When a user clicks an individual data point on the regression plot, the `vals$keeprows` array is updated to `FALSE`.
```r
# Toggle points that are clicked
observeEvent(input$regression_plot_output_click, {
    res <- nearPoints(selected_melted_data(), input$regression_plot_output_click, allRows = TRUE) 
    vals$keeprows <- xor(vals$keeprows, res$selected_) # keeprows array is updated 
})
```   
Any final data the user decides to include in the analysis is assigned in the data frame `keep()` and is used as an argument to the plots, tables and calculations for the final outputs. 
    


This will output the % of 4C Reference MFI dataframe that is rendered to the first tab of the main panel in the UI, "Stats Table", with only the concentrations to include in the analysis outputted. The output of this function is:
***

### Final Outputs / Downloads

***

### Constants

***
### Sidebar Panel

### Main Panel

